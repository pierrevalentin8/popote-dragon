<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Popote & Compagnie</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background:white; text-align:center; }
h1,h2 { color: orange; font-family: "Comic Sans MS", cursive; }
button {
    background: orange; color:white; border:none; border-radius:12px; padding:10px 15px; margin:5px;
    cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:0.2s;
}
button:hover { transform: scale(1.05); }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:10px; }
#monthsGrid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; max-width:500px; margin:20px auto; }
#membersList { max-width:600px; margin:20px auto; padding:10px; text-align:left; }
.memberItem span {
    display:inline-block; font-family:'Verdana', Geneva, sans-serif; font-size:18px; color:#333;
    padding:12px 20px; border-radius:12px; margin:8px 0; width:calc(100% - 40px);
    box-shadow:0 3px 6px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;
}
.memberItem span:hover { transform: translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.2); }
table { border-collapse:collapse; margin:20px auto; width:85%; }
th,td { border:1px solid black; padding:6px; }
input { width:60px; }
footer { position:fixed; bottom:10px; width:100%; font-size:12px; }
/* Boutons discrets en haut √† gauche */
.top-left {
  position: fixed;
  top: 10px;
  left: 10px;
  display: flex;
  gap: 6px;
  z-index: 1000;
}

.mini-btn {
  background: transparent;
  color: orange;
  border: 1px solid orange;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  box-shadow: none;
}

.mini-btn:hover {
  background: orange;
  color: white;
}

/* Gros bouton Popote centr√© mobile */
.main-popote-btn {
  margin-top: 120px;
  padding: 20px 40px;
  font-size: 26px;
  border-radius: 25px;
  background: linear-gradient(135deg, orange, #ff9f1c);
  box-shadow: 0 6px 15px rgba(0,0,0,0.25);
  transition: transform 0.2s, box-shadow 0.2s;
}

.main-popote-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

/* Mobile first */
@media (max-width: 600px) {
  .main-popote-btn {
    width: 80%;
    font-size: 28px;
    padding: 25px;
  }
}
.intro-text {
  max-width: 90%;
  margin: 60px auto 30px auto;
  text-align: center;
}

.intro-text h2 {
  font-size: 22px;
  margin-bottom: 10px;
  color: orange;
}

.intro-text p {
  font-size: 15px;
  color: #555;
  line-height: 1.4;
}

@media (max-width: 600px) {
  .intro-text h2 {
    font-size: 20px;
  }
  .intro-text p {
    font-size: 14px;
  }
}
.memberItem {
  cursor: grab;
}

.memberItem:active {
  cursor: grabbing;
}

#sortModal button {
  width: 100%;
}
/* SECTION ANNONCES */
.annonces-box {
  max-width: 600px;
  margin: 40px auto;
  background: #fff7e6;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  text-align: left;
}

.annonces-box h2 {
  text-align: center;
  margin-bottom: 15px;
}

.annonces-box ul {
  list-style: none;
  padding: 0;
}

.annonces-box li {
  padding: 8px 0;
  border-bottom: 1px dashed #f0b35c;
  font-size: 14px;
  color: #444;
}

.annonces-box li:last-child {
  border-bottom: none;
}

</style>
</head>
<body>
  <!-- PAGE LOGIN / INSCRIPTION -->
<div id="authPage">
  <h1>Popote & Compagnie</h1>

  <div class="intro-text">
    <h2>Bienvenue !</h2>
    <p>Connectez-vous ou cr√©ez un compte pour acc√©der √† Popote & Compagnie.</p>
  </div>

  <div style="margin:20px;">
    <button class="main-popote-btn" onclick="showLoginForm()">Connexion</button>
    <button class="main-popote-btn" onclick="askUnitCode()">Cr√©er un compte</button>

  </div>

  <!-- FORMULAIRE CONNEXION -->
  <div id="loginForm" class="modal-content" style="display:none; max-width:400px; margin:auto;">
    <h3>Connexion</h3>
    <input type="email" id="loginEmail" placeholder="Email"><br><br>
    <div style="position:relative;">
      <input type="password" id="loginPassword" placeholder="Mot de passe" style="width:100%;">
      <button type="button" onclick="togglePassword('loginPassword')" style="position:absolute; right:5px; top:5px;">üëÅÔ∏è</button>
    </div><br>
    <button onclick="login()">Valider</button>
    <button onclick="hideForms()">Annuler</button>
  </div>

  <!-- FORMULAIRE CREATION COMPTE -->
  <div id="signupForm" class="modal-content" style="display:none; max-width:400px; margin:auto;">
    <h3>Cr√©er un compte</h3>
    <input type="email" id="signupEmail" placeholder="Email"><br><br>
    <div style="position:relative;">
      <input type="password" id="signupPassword" placeholder="Mot de passe" style="width:100%;">
      <button type="button" onclick="togglePassword('signupPassword')" style="position:absolute; right:5px; top:5px;">üëÅÔ∏è</button>
    </div><br>
    <button onclick="signup()">Cr√©er</button>
    <button onclick="hideForms()">Annuler</button>
  </div>
</div>


<!-- ACCUEIL -->
<div id="homePage" style="display:none;">

<h1>Popote & Compagnie</h1>
<div class="top-left">
  <button class="mini-btn" onclick="openLogin()">Connexion</button>
  <button class="mini-btn" onclick="logout()">D√©connexion</button>
</div>
<div class="intro-text">
  <h2>La Popote Montechoise se modernise.</h2>
  <p>Popote & Compagnie est l√† pour sublimer ton exp√©rience avec la popote.</p>
</div>

<!-- SECTION ANNONCES -->
<div class="annonces-box">
  <h2>üì¢ Annonces</h2>
  <ul id="annoncesList">
    <li><strong>üÜï </strong> : Lancement de Popote & Compagnie !</li>
    <li>üîê Demande code unit√© avant cr√©ation de compte</li>
    <li>üìÖ Suivi mensuel des consommations</li>
    <li>üöÄ √Ä venir : cr√©ation rubrique SPORT / Cr√©ation Popote &Dragon</li>
  </ul>
</div>


<button class="main-popote-btn" onclick="goPopote()">üçΩÔ∏è Popote</button>
<button class="main-popote-btn" onclick="goDragon()">üçó Popote & Dragon üêâ</button>


<footer>La Popote 2.0 - BETA 9 - Cr√©√© avec l'aide de Chat GPT</footer>
</div>



<!-- PAGE POPOTE -->
<div id="popotePage" style="display:none;">
  <h2>Popote</h2>
  <button onclick="openAdd()">+ Ajouter membre</button>
  <button onclick="openSort()">üîÄ Trier les membres</button>
  <button onclick="goHome()">Retour</button>

  <h3>Membres</h3>
  <div id="membersList"></div>

  <h3>Mois</h3>
  <div id="monthsGrid"></div>
</div>


<!-- PAGE MOIS -->
<div id="monthPage" style="display:none;">
<h2 id="monthTitle"></h2>
<button onclick="goPopote()">Retour Popote</button>

<table>
<thead>
<tr>
<th>Nom</th>
<th>Pr√©nom</th>
<th>Eau</th>
<th>Soda</th>
<th>Gourmandise</th>
<th>Caf√©</th>
<th>Total ‚Ç¨</th>
</tr>
</thead>
<tbody id="monthTable"></tbody>
</table>
<div class="totalBox">
Total du mois : <span id="monthTotal">0.00</span> ‚Ç¨
</div>
</div>

<!-- MODAL LOGIN -->
<div class="modal" id="loginModal">
<div class="modal-content">
<h3>Connexion</h3>
<input type="text" id="pseudo" placeholder="Email"><br><br>
<input type="password" id="password" placeholder="Mot de passe"><br><br>
<button onclick="login()">Valider</button>
<button onclick="closeLogin()">Retour</button>
</div>
</div>

<!-- MODAL AJOUT -->
<div class="modal" id="addModal">
<div class="modal-content">
<h3>Ajouter un membre</h3>
<input type="text" id="nom" placeholder="Nom"><br><br>
<input type="text" id="prenom" placeholder="Pr√©nom"><br><br>
<button onclick="addMember()">Valider</button>
<button onclick="closeAdd()">Annuler</button>
</div>
</div>
<!-- MODAL TRI MEMBRES -->
<div class="modal" id="sortModal">
  <div class="modal-content">
    <h3>Trier les membres</h3>
    <button onclick="sortMembers('alpha')">üî§ Ordre alphab√©tique</button><br><br>
    <button onclick="sortMembers('asc')">üìà Total croissant</button><br><br>
    <button onclick="sortMembers('desc')">üìâ Total d√©croissant</button><br><br>
    <button onclick="closeSort()">Annuler</button>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
 apiKey: "AIzaSyAJFyX4n6s5ER6_LiS22JtJ01VBvR8YM0g",
  authDomain: "popotecompagnie-2e79f.firebaseapp.com",
  projectId: "popotecompagnie-2e79f",
  storageBucket: "popotecompagnie-2e79f.firebasestorage.app",
  messagingSenderId: "643014117897",
  appId: "1:643014117897:web:254fd7aad817ed902086d8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
</script>

<script>
let members = [];
let consumptions = {};
const prices = {eau:0.5, soda:0.7, gour:0.5};
const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
let isAdmin = false;

// === AUTHENTIFICATION VIA FIREBASE ===
function openLogin() { document.getElementById("loginModal").style.display = "flex"; }
function closeLogin() { document.getElementById("loginModal").style.display = "none"; }

function login() {
    const email = document.getElementById("pseudo").value.trim();
    const password = document.getElementById("password").value;

    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            isAdmin = true;
            closeLogin();
            updateMembersList();
        })
        .catch(err => {
            console.log("Erreur login:", err.code, err.message);
            // Ne rien faire c√¥t√© interface si √©chec
        });
}

function logout() {
    auth.signOut().then(() => {
        isAdmin = false;
        updateMembersList();
    });
}
// === GESTION FORMULAIRES LOGIN / SIGNUP ===
function showLoginForm() {
  document.getElementById("loginForm").style.display = "block";
  document.getElementById("signupForm").style.display = "none";
}

function showSignupForm() {
  document.getElementById("signupForm").style.display = "block";
  document.getElementById("loginForm").style.display = "none";
}

function hideForms() {
  document.getElementById("loginForm").style.display = "none";
  document.getElementById("signupForm").style.display = "none";
}

// === BASCULER MOT DE PASSE ===
function togglePassword(id){
  const input = document.getElementById(id);
  if(input) input.type = input.type === "password" ? "text" : "password";
}

// === AUTHENTIFICATION FIREBASE ===
function signup(){
  const email = document.getElementById("signupEmail").value.trim();
  const password = document.getElementById("signupPassword").value;

  if(!email || !password){
    alert("Veuillez remplir tous les champs.");
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then(() => {
      alert("Compte cr√©√© ! Vous pouvez maintenant vous connecter.");
      hideForms();
      showLoginForm();
    })
    .catch(err => {
      console.error("Erreur cr√©ation compte:", err);
      alert("Erreur cr√©ation compte : " + err.message);
    });
}

function login(){
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;

  if(!email || !password){
    alert("Veuillez remplir tous les champs.");
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      document.getElementById("authPage").style.display = "none";
      document.getElementById("homePage").style.display = "block";
      if(typeof updateMembersList === "function") updateMembersList();
    })
    .catch(err => {
      console.error("Erreur connexion:", err);
      alert("Erreur connexion : " + err.message);
    });
}

// === V√©rifier l'√©tat de connexion au chargement ===
auth.onAuthStateChanged(user => {
  if(user){
    isAdmin = (user.email === "pierre.valentin8@gmail.com");
    updateMembersList();
  } else {
    isAdmin = false;
  }
});


// V√©rifie l'√©tat de connexion au d√©marrage
auth.onAuthStateChanged(user => {
    if (user) {
        isAdmin = (user.email === "pierre.valentin8@gmail.com");
        updateMembersList();
    } else {
        isAdmin = false;
        updateMembersList();
    }
});


// === NAVIGATION ===
function goPopote(){ document.getElementById("homePage").style.display="none"; document.getElementById("monthPage").style.display="none"; document.getElementById("popotePage").style.display="block"; updateMembersList(); }
function goHome(){ document.getElementById("popotePage").style.display="none"; document.getElementById("homePage").style.display="block"; }
function goDragon(){
  window.location.href = "https://pierrevalentin8.github.io/popote-dragon/";
}

// === AJOUT MEMBRE ===
function openAdd(){ if(!isAdmin) return; document.getElementById("addModal").style.display="flex"; }
function closeAdd(){ document.getElementById("addModal").style.display="none"; }
function addMember(){
  if(!isAdmin) return alert("Seul l'admin peut ajouter un membre !");
    const nom = document.getElementById("nom").value.trim();
    const prenom = document.getElementById("prenom").value.trim();
    if(!nom || !prenom) return;
    if(members.some(m=>m.nom===nom && m.prenom===prenom)) return;
    members.push({nom,prenom});
    months.forEach(m=>{ if(!consumptions[m]) consumptions[m]=[]; consumptions[m].push({nom,prenom,eau:0,soda:0,gour:0,cafe:0}); });
    saveData();
    closeAdd();
}

// === CALCUL TOTAL ANNUEL ===
function calculateAnnualTotal(member){
    let total=0;
    months.forEach(month=>{
        if(consumptions[month]){
            let c=consumptions[month].find(cm=>cm.nom===member.nom && cm.prenom===member.prenom);
            if(c) total += c.eau*prices.eau + c.soda*prices.soda + c.gour*prices.gour + c.cafe;
        }
    });
    return total.toFixed(2);
}


// === LISTE MEMBRES AVEC DRAG & DROP ===
let draggedIndex = null;
// === TRI DES MEMBRES ===
function openSort(){
  if(!isAdmin){
    alert("Seul l'admin peut trier !");
    return;
  }
  document.getElementById("sortModal").style.display = "flex";
}

function closeSort(){
  document.getElementById("sortModal").style.display = "none";
}

function sortMembers(type){
  if(!isAdmin) return;

  let indices = members.map((m, i) => ({m, i}));

  if(type === "alpha"){
    indices.sort((a,b)=> (a.m.nom+a.m.prenom).localeCompare(b.m.nom+b.m.prenom));
  }
  else if(type === "asc"){
    indices.sort((a,b)=> calculateAnnualTotal(a.m) - calculateAnnualTotal(b.m));
  }
  else if(type === "desc"){
    indices.sort((a,b)=> calculateAnnualTotal(b.m) - calculateAnnualTotal(a.m));
  }

  // R√©ordonner members
  members = indices.map(obj => obj.m);

  // R√©ordonner consommations pour chaque mois
  months.forEach(month=>{
    if(consumptions[month]){
      consumptions[month] = indices.map(obj => consumptions[month][obj.i]);
    }
  });

  saveData();
  updateMembersList();
  closeSort();
}

function updateMembersList(){
    const list = document.getElementById("membersList");
    list.innerHTML = "";

    members.forEach((m, i) => {
        let div = document.createElement("div");
        div.className = "memberItem";
        div.draggable = isAdmin;
        div.dataset.index = i;

        if(isAdmin){
            div.addEventListener("dragstart", dragStart);
            div.addEventListener("dragover", dragOver);
            div.addEventListener("drop", dropMember);
        }

        let bgColor = (i % 2 === 0) ? "#ffe5b4" : "#ffd699";
        div.innerHTML = `
          <span style="background-color:${bgColor}">
            ${m.nom} ${m.prenom} ‚Äî Total 2026 : ${calculateAnnualTotal(m)} ‚Ç¨
          </span>
        `;

        if(isAdmin){
            let btn = document.createElement("button");
            btn.textContent = "Supprimer";
            btn.style.marginLeft = "15px";
            btn.onclick = () => deleteMember(i);
            div.appendChild(btn);
        }

        list.appendChild(div);
    });
}

function dragStart(e){
    draggedIndex = Number(e.currentTarget.dataset.index);
    e.currentTarget.style.opacity = "0.5";
}

function dragOver(e){
    e.preventDefault();
}

function dropMember(e){
    e.preventDefault();
    const targetIndex = Number(e.currentTarget.dataset.index);
    if(draggedIndex === null || draggedIndex === targetIndex) return;

    // D√©placer membre
    const movedMember = members.splice(draggedIndex, 1)[0];
    members.splice(targetIndex, 0, movedMember);

    // D√©placer aussi les consommations
    months.forEach(month => {
        if(consumptions[month]){
            const movedCons = consumptions[month].splice(draggedIndex, 1)[0];
            consumptions[month].splice(targetIndex, 0, movedCons);
        }
    });

    draggedIndex = null;
    saveData();
    updateMembersList();
}


// === SUPPRESSION MEMBRE ===
function deleteMember(index){
    if(!isAdmin) return;
    let member=members[index]; members.splice(index,1);
    months.forEach(m=>{ if(consumptions[m]) consumptions[m]=consumptions[m].filter(c=>!(c.nom===member.nom && c.prenom===member.prenom)); });
    saveData();
}

// === MOIS ===
function loadMonths(){
    const div=document.getElementById("monthsGrid");
    months.forEach(m=>{ let btn=document.createElement("button"); btn.textContent=m; btn.onclick=()=>openMonth(m); div.appendChild(btn); });
}
loadMonths();

function openMonth(month){
    document.getElementById("popotePage").style.display="none";
    document.getElementById("monthPage").style.display="block";
    document.getElementById("monthTitle").textContent=month;
    const tbody=document.getElementById("monthTable"); tbody.innerHTML="";
    if(!consumptions[month]) consumptions[month]=[];
    consumptions[month].forEach((m,i)=>{
        let row=tbody.insertRow();
        row.insertCell().textContent=m.nom;
        row.insertCell().textContent=m.prenom;
        ["eau","soda","gour","cafe"].forEach((key,j)=>{
            let cell=row.insertCell();
            cell.innerHTML=`<input type="number" min="0" value="${m[key]}" ${!isAdmin?'disabled':''} oninput="updateConsumption('${month}',${i})">`;
        });
        row.insertCell().textContent=(m.eau*prices.eau + m.soda*prices.soda + m.gour*prices.gour + m.cafe).toFixed(2);
    });
    updateMonthTotal(month);
}

// === CALCULS ET SAUVEGARDE ===
function updateConsumption(month,index){
    if(!isAdmin) return;
    const row=document.getElementById("monthTable").rows[index];
    const m=consumptions[month][index];
    m.eau=parseFloat(row.cells[2].children[0].value)||0;
    m.soda=parseFloat(row.cells[3].children[0].value)||0;
    m.gour=parseFloat(row.cells[4].children[0].value)||0;
    m.cafe=parseFloat(row.cells[5].children[0].value)||0;
    row.cells[6].textContent=(m.eau*prices.eau + m.soda*prices.soda + m.gour*prices.gour + m.cafe).toFixed(2);
    updateMonthTotal(month);
    saveData();
}

function updateMonthTotal(month){
    let sum=consumptions[month].reduce((acc,m)=>acc + (m.eau*prices.eau + m.soda*prices.soda + m.gour*prices.gour + m.cafe),0);
    document.getElementById("monthTotal").textContent=sum.toFixed(2);
}

// === FIRESTORE SAUVEGARDE ET SYNCHRO ===
function saveData(){
    if(!isAdmin) return;  // seuls les admins sauvegardent
    db.collection("popoteData").doc("main").set({members, consumptions})
    .then(()=>console.log("Donn√©es sauvegard√©es"))
    .catch(err=>console.error(err));
}


db.collection("popoteData").doc("main").onSnapshot(doc=>{
    if(doc.exists){
        const data = doc.data();
        members = data.members || [];
        consumptions = data.consumptions || {};
        updateMembersList();
    }
});

// === CODE UNITE AVANT INSCRIPTION ===
function askUnitCode(){
  hideForms(); // cache login/signup si visibles
  document.getElementById("unitCodeModal").style.display = "flex";
}

function closeUnitCode(){
  document.getElementById("unitCodeModal").style.display = "none";
  document.getElementById("unitCodeInput").value = "";
}

function validateUnitCode(){
  const code = document.getElementById("unitCodeInput").value.trim();

  if(code === "15315"){
    closeUnitCode();
    showSignupForm(); // ouvre le formulaire d'inscription apr√®s validation
  } else {
    alert("Code unit√© incorrect !");
    closeUnitCode();
    hideForms(); // retour propre √† l'accueil authPage
  }
}


</script>

<!-- MODAL CODE UNITE -->
<div class="modal" id="unitCodeModal">
  <div class="modal-content">
    <h3>Quelle est ton code unit√© ?</h3>
    <input type="text" id="unitCodeInput" placeholder="Code unit√©"><br><br>
    <button onclick="validateUnitCode()">Valider</button>
    <button onclick="closeUnitCode()">Annuler</button>
  </div>
</div>


</body>
</html>
