<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Popote & Dragons</title>
<style>
body { 
    font-family: 'Courier New', monospace; 
    color: #3b2f2f; /* texte marron fonc√© sur fond clair */
    background-color: #d2b48c; /* marron clair style parchemin */
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    margin: 0; 
}

    .login-container, .village-container { background-color: rgba(0,0,0,0.75); padding: 30px; border: 3px solid #d4af37; border-radius: 15px; text-align: center; min-width: 320px; }
   h1, h2, h3 {
    color: #d4af37; /* dor√© */
    text-shadow: 1px 1px #3b2f2f; /* ombre marron fonc√© */
}

    button { font-family: 'Courier New', monospace; background-color: #444; color: #f5f5dc; border: 2px solid #d4af37; padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 1em; border-radius: 5px; width: 90%; }
    button:hover { background-color: #555; }
    .popup { display: none; position: fixed; top:50%; left:50%; transform: translate(-50%,-50%); background-color: rgba(0,0,0,0.95); padding:30px; border:2px solid #d4af37; border-radius:10px; z-index:1000; min-width:320px; }
    .popup input, .popup select { display:block; margin:10px auto; padding:8px; border-radius:5px; border:1px solid #d4af37; width:85%; background-color:#222; color:#f5f5dc; }
    .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:500; }
   /* === Village layout esth√©tique retro fantasy === */
.village-container { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 20px; }
.village-header { text-align: center; }
#villageImageDragon,
#villageImageSerpent {
    max-width: 400px;  /* comme avant */
    width: 80%;        /* comme avant */
    border: 3px solid #d4af37;
    border-radius: 10px;
    margin-bottom: 10px;
}

.village-header h1 { color: #d4af37; font-size: 2.5em; text-shadow: 2px 2px #000; margin-bottom: 20px; }

.village-main { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 30px; width: 100%; max-width: 900px; }
.player-panel { background-color: rgba(0,0,0,0.75); border: 2px solid #d4af37; border-radius: 10px; padding: 20px; flex: 2; color: #f5f5dc; }
.player-panel h2, .player-panel h3 { margin: 10px 0; }
.player-panel ul { list-style: none; padding: 0; text-align: left; font-size: 1.1em; }
.player-panel li { margin: 5px 0; }

.actions-panel { display: flex; flex-direction: column; gap: 10px; flex: 1; align-items: flex-end; }
.actions-panel button { width: 120px; background-color: rgba(68,68,68,0.9); border: 2px solid #d4af37; font-size: 0.95em; }
.actions-panel button:hover { background-color: rgba(85,85,85,0.95); }

/* Responsive */
@media screen and (max-width: 768px){
    .village-main { flex-direction: column; align-items: center; }
    .actions-panel { align-items: center; }
}
.login-footer {
    margin-top: 20px;
    text-align: center;
    color: #f5f5dc;
    font-size: 0.9em;
    border-top: 2px solid #d4af37;
    padding-top: 5px;
}
button {
  box-shadow: 2px 2px 0 #000;
}
button:active {
  box-shadow: none;
  transform: translate(2px,2px);
}
h1, h2, h3 {
  font-family: 'IM Fell English SC', serif;
}
.stat-row {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 5px 0;
    gap: 5px;
}
.stat-row button {
    width: 30px;
    padding: 2px 5px;
    font-size: 1em;
    cursor: pointer;
}
.stat-row span {
    width: 30px;
    text-align: center;
    display: inline-block;
}
/* === FICHE PERSONNAGE CLAIRE ET LISIBLE === */
#characterSheetPopup {
    background-color: #f5f5dc; /* fond beige clair */
    color: #3b2f2f; /* texte marron fonc√© */
    border: 3px solid #d4af37; /* bordure dor√©e */
    border-radius: 15px;
    padding: 25px 30px;
    min-width: 350px;
    max-width: 450px;
    text-align: center;
    font-size: 1em;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
}

#characterSheetPopup h2 {
    color: #d4af37;
    text-shadow: 1px 1px #3b2f2f;
    font-size: 1.8em;
    margin-bottom: 15px;
}

#characterSheetPopup .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(255,255,255,0.8);
    padding: 6px 10px;
    margin: 6px 0;
    border-radius: 8px;
    font-weight: bold;
    color: #3b2f2f;
}

#characterSheetPopup .stat-row button {
    width: 35px;
    height: 30px;
    font-size: 1em;
    font-weight: bold;
    background-color: #d4af37;
    color: #3b2f2f;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#characterSheetPopup .stat-row button:hover {
    background-color: #e6c35c;
}

#characterSheetPopup span {
    min-width: 35px;
    display: inline-block;
    text-align: center;
}

#characterSheetPopup #pcText {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 12px;
}
#characterSheetPopup #pcText {
    font-weight: bold;
    font-size: 1.2em;
    margin-bottom: 12px;
    background-color: rgba(150, 126, 46, 0.2); /* l√©ger fond dor√© derri√®re le texte */
    padding: 4px 8px;
    border-radius: 5px;
}
/* === Tableau Admin Fantasy === */
/* Inputs et selects dans le tableau admin */
#adminPlayersList select {
    width: 100%;             /* prend toute la largeur de la cellule */
    padding: 4px 6px;
    border-radius: 5px;
    border: 1px solid #d4af37;
    background-color: #222;
    color: #f5f5dc;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    text-align: center;
}

#adminPlayersList td {
    min-width: 150px;       /* largeur minimale pour que le contenu tienne */
}

#adminPlayersList td button {
    width: 100%;             /* bouton prend toute la cellule */
    box-sizing: border-box;
}
/* Admin Table responsive */
#adminPlayersList {
    overflow-x: auto; /* scroll horizontal si n√©cessaire */
    margin-top: 10px;
}

#adminPlayersList table {
    border-collapse: collapse;
    width: auto;
    margin: 0 auto;
}

#adminPlayersList th, #adminPlayersList td {
    border: 1px solid #3b2f2f;
    padding: 5px;
    min-width: 80px;
    text-align: center;
}

/* Mobile friendly */
@media screen and (max-width: 400px){
    .village-main { flex-direction: column; align-items: center; gap: 15px; }
    .actions-panel { align-items: center; width: 100%; }
    .actions-panel button { width: 90%; }
    #characterSheetPopup { min-width: 90%; max-width: 95%; padding: 15px; }
    #adminPlayersList table { width: 100%; }
    #adminPlayersList th, #adminPlayersList td { min-width: auto; padding: 3px; font-size: 0.85em; }
}
/* ===== IMAGE PAGE DE CONNEXION ===== */
.login-logo {
    display: block;
    margin: 0 auto 15px auto; /* centr√© + espace en dessous */
    max-width: 180px;        /* taille desktop */
    width: 80%;              /* responsive mobile */
    height: auto;
}

/* Mobile */
@media screen and (max-width: 400px){
    .login-logo {
        max-width: 140px;
        margin-bottom: 10px;
    }
}



</style>
</head>
<body>
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<div class="login-container" id="loginPage">

    <!-- IMAGE EN HAUT -->
    <img src="Popote Dragon.png"
         alt="Popote & Dragons"
         class="login-logo">

    <!-- TITRE -->
    <h1>Popote & Dragons</h1>

    <!-- BOUTONS -->
    <button id="createBtn">Cr√©er un compte</button>
    <button id="loginBtn">Connexion</button>

    <!-- FOOTER -->
    <div class="login-footer">
        2026 - Imagin√© et cr√©√© par PM avec l'aide de Chat GPT - MAJ 06
    </div>

</div>




<!-- ===== VILLAGE DRAGON POURPRE ===== -->
<div class="village-container" id="villageDragon" style="display:none;">
    <div class="village-header">
        <img src="village1.png" alt="Village Dragon Pourpre" id="villageImageDragon">
        <h1>Ordre du Dragon Pourpre ‚öîÔ∏è</h1>
    </div>

    <div class="village-main">
        <div class="player-panel">
            <h2 id="welcomeTextDragon">Bienvenue, aventurier.</h2>
            <p id="teamTextDragon"></p>
            <p id="levelTextDragon"></p>
            <p id="xpTextDragon"></p>
        </div>

        <div class="actions-panel">
            <button class="openCharacterSheetBtn">üìù Fiche</button>
            <button class="exploreBtn">üå≥ Explorer</button>
            <button class="inventoryBtn">üéí Inventaire</button>
            <button class="logoutBtn">üö™ D√©connexion</button>
            <button class="adminBtn" style="display:none;">‚öîÔ∏è Admin</button>
        </div>
    </div>
</div>

<!-- ===== VILLAGE SERPENT NOIR ===== -->
<div class="village-container" id="villageSerpent" style="display:none;">
    <div class="village-header">
        <img src="village1.png" alt="Village Serpent Noir" id="villageImageSerpent">
        <h1>Confr√©rie du Serpent Noir üêç</h1>
    </div>

    <div class="village-main">
        <div class="player-panel">
            <h2 id="welcomeTextSerpent">Bienvenue, aventurier.</h2>
            <p id="teamTextSerpent"></p>
            <p id="levelTextSerpent"></p>
            <p id="xpTextSerpent"></p>
        </div>

        <div class="actions-panel">
            <button class="openCharacterSheetBtn">üìù Fiche</button>
            <button class="exploreBtn">üå≥ Explorer</button>
            <button class="inventoryBtn">üéí Inventaire</button>
            <button class="logoutBtn">üö™ D√©connexion</button>
            <button class="adminBtn" style="display:none;">‚öîÔ∏è Admin</button>
        </div>
    </div>
</div>



<!-- POPUPS -->
<div class="popup" id="adminPopup">
    <h2>‚öîÔ∏è Panel Admin ‚öîÔ∏è</h2>
    <div id="adminPlayersList" style="margin-top:10px;"></div>
    <p>Bienvenue, Ma√Ætre du Donjon.</p>
    <button id="adminClose">Fermer</button>
</div>

<div class="popup" id="createPopup">
    <h2>Cr√©er un compte</h2>
    <input type="email" id="createEmail" placeholder="Adresse email">
    <input type="password" id="createPassword" placeholder="Mot de passe">
    <button id="createSubmit">Valider</button>
    <button id="createBack">Retour</button>
</div>

<div class="popup" id="loginPopup">
    <h2>Connexion</h2>
    <input type="email" id="loginEmail" placeholder="Adresse email">
    <input type="password" id="loginPassword" placeholder="Mot de passe">
    <button id="loginSubmit">Se connecter</button>
    <button id="loginBack">Retour</button>
</div>

<div class="popup" id="characterPopup">
    <h2>Viens prendre part √† cette aventure</h2>
    <input type="text" id="characterName" placeholder="Nom du personnage">
    <select id="characterClass">
        <option value="">-- Classe --</option>
        <option>Guerrier</option>
        <option>Voleur</option>
        <option>Mage</option>
        <option>N√©cromancien</option>
        <option>Archer</option>
        
    </select>
    <p>Points de comp√©tence restants : <span id="pointsRestants">10</span></p>
    <label>Attaque</label><input type="number" id="statAttaque" min="0" value="0">
    <label>D√©fense</label><input type="number" id="statDefense" min="0" value="0">
    <label>Esquive</label><input type="number" id="statEsquive" min="0" value="0">
    <label>Points de vie</label><input type="number" id="statVie" min="0" value="0">
    <button id="characterSubmit">Entrer dans le monde</button>
</div>

<div class="popup" id="characterSheetPopup">
    <h2>üõ°Ô∏è Fiche Personnage üó°Ô∏è</h2>

    <!-- INFOS G√âN√âRALES -->
    <p id="sheetClass"></p>
    <p id="sheetTeam"></p>
    <p id="sheetLevel"></p>

    <p id="pcText" data-pc="0">Points de Comp√©tence restants : 0</p>

    <!-- STATS + / - -->
    <div class="stat-row">
        <span>Attaque: </span>
        <button class="dec" data-stat="attaque">-</button>
        <span id="sheetAttaque">0</span>
        <button class="inc" data-stat="attaque">+</button>
    </div>
    <div class="stat-row">
        <span>D√©fense: </span>
        <button class="dec" data-stat="defense">-</button>
        <span id="sheetDefense">0</span>
        <button class="inc" data-stat="defense">+</button>
    </div>
    <div class="stat-row">
        <span>Esquive: </span>
        <button class="dec" data-stat="esquive">-</button>
        <span id="sheetEsquive">0</span>
        <button class="inc" data-stat="esquive">+</button>
    </div>
    <div class="stat-row">
        <span>Vie: </span>
        <button class="dec" data-stat="vie">-</button>
        <span id="sheetVie">0</span>
        <button class="inc" data-stat="vie">+</button>
    </div>

    <button id="saveStatsBtn">Valider</button>
    <button id="cancelStatsBtn">Annuler</button>
</div>



<div class="overlay" id="overlay"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ===== CONFIG FIREBASE =====
  const firebaseConfig = {
    apiKey: "AIzaSyDxSVEnK9stHRQxF-WEUAaVQ5OjM1jqmXU",
    authDomain: "popoteetdragonv2.firebaseapp.com",
    projectId: "popoteetdragonv2",
    storageBucket: "popoteetdragonv2.firebasestorage.app",
    messagingSenderId: "1012170229310",
    appId: "1:1012170229310:web:4914b80585158c0c42736f"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ===== VARIABLES =====
  let currentUser = null;
  let teamToggle = 0;
  const creationPointsRestants = 10;
  const adminEmail = "pierre.valentin8@gmail.com";

  // DOM Elements
  const overlay = document.getElementById('overlay');
  const loginPage = document.getElementById('loginPage');
  const villageDragon = document.getElementById('villageDragon');
  const villageSerpent = document.getElementById('villageSerpent');
  const createPopup = document.getElementById('createPopup');
  const loginPopup = document.getElementById('loginPopup');
  const characterPopup = document.getElementById('characterPopup');
  const characterSheetPopup = document.getElementById('characterSheetPopup');

  const statAttaque = document.getElementById('statAttaque');
  const statDefense = document.getElementById('statDefense');
  const statEsquive = document.getElementById('statEsquive');
  const statVie = document.getElementById('statVie');
  const pointsRestantsSpan = document.getElementById('pointsRestants');

  const pcText = document.getElementById('pcText');
  const sheetAttaque = document.getElementById('sheetAttaque');
  const sheetDefense = document.getElementById('sheetDefense');
  const sheetEsquive = document.getElementById('sheetEsquive');
  const sheetVie = document.getElementById('sheetVie');
  const saveStatsBtn = document.getElementById('saveStatsBtn');
  const cancelStatsBtn = document.getElementById('cancelStatsBtn');

  const adminPopup = document.getElementById('adminPopup');
  const adminPlayersList = document.getElementById('adminPlayersList');

  // ========================
  // FIREBASE AUTH STATE
  // ========================
  auth.onAuthStateChanged(async (user) => {
      if (user) {
          currentUser = user.uid;
          const doc = await db.collection('players').doc(currentUser).get();
          const data = doc.exists ? doc.data() : {character:null, level:1, xp:0};

          if(data.character){
              loginPage.style.display = 'none';
              showVillage(data);
          } else {
              overlay.style.display='block';
              characterPopup.style.display='block';
          }
      } else {
          currentUser = null;
          villageDragon.style.display = 'none';
          villageSerpent.style.display = 'none';
          loginPage.style.display = 'block';
      }
  });

  // ========================
  // SHOW VILLAGE
  // ========================
  function showVillage(playerData) {
      villageDragon.style.display = 'none';
      villageSerpent.style.display = 'none';

      let villageEl, welcomeText, teamText, levelText, xpText;
      if(playerData.character.team.includes('Dragon Pourpre')){
          villageEl = villageDragon;
          welcomeText = document.getElementById('welcomeTextDragon');
          teamText = document.getElementById('teamTextDragon');
          levelText = document.getElementById('levelTextDragon');
          xpText = document.getElementById('xpTextDragon');
      } else {
          villageEl = villageSerpent;
          welcomeText = document.getElementById('welcomeTextSerpent');
          teamText = document.getElementById('teamTextSerpent');
          levelText = document.getElementById('levelTextSerpent');
          xpText = document.getElementById('xpTextSerpent');
      }

      villageEl.style.display = 'block';
      loginPage.style.display = 'none';

      welcomeText.textContent = `Bienvenue ${playerData.character.name}, ${playerData.character.classe}.`;
      teamText.textContent = `√âquipe : ${playerData.character.team}`;
      levelText.textContent = `Niveau : ${playerData.level || 1}`;
      xpText.textContent = `XP : ${playerData.xp || 0} / ${10 * (playerData.level || 1)}`;

      const adminBtn = villageEl.querySelector('.adminBtn');
      if(adminBtn) {
          adminBtn.style.display = currentUser && auth.currentUser?.email === adminEmail ? 'inline-block' : 'none';
          adminBtn.onclick = adminHandler;
      }

      const logoutBtn = villageEl.querySelector('.logoutBtn');
      if(logoutBtn) logoutBtn.onclick = logoutPlayer;

      document.querySelectorAll('.openCharacterSheetBtn').forEach(btn => {
          btn.onclick = async () => {
              const playerDoc = await db.collection('players').doc(currentUser).get();
              const data = playerDoc.data();
              if(!data.character){ alert("Aucun personnage cr√©√©."); return; }
              openCharacterSheet(data);
          };
      });
  }

  function showVillageForCurrentUser(team){
      if(team.includes('Dragon Pourpre')){
          villageDragon.style.display = 'block';
          villageSerpent.style.display = 'none';
      } else {
          villageDragon.style.display = 'none';
          villageSerpent.style.display = 'block';
      }
  }

  // ========================
  // LOGOUT
  // ========================
  function logoutPlayer(){
      auth.signOut();
      currentUser = null;
      villageDragon.style.display = 'none';
      villageSerpent.style.display = 'none';
      loginPage.style.display = 'block';
  }

  // ========================
  // ADMIN HANDLER
  // ========================
  async function adminHandler() {
    overlay.style.display = 'block';
    adminPopup.style.display = 'block';
    adminPlayersList.innerHTML = '';

    // Cr√©ation du tableau
    const table = document.createElement('table');

    // Ent√™te
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr style="background-color:#d4af37;color:#000;">
            <th>Nom</th>
            <th>Classe</th>
            <th>√âquipe</th>
            <th>Niveau</th>
            <th>XP</th>
            <th>Actions</th>
        </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const snapshot = await db.collection('players').get();

    snapshot.forEach(docSnap => {
        const player = docSnap.data();
        const uid = docSnap.id;

        const tr = document.createElement('tr');

        if(player.character){
            // Nom
            const tdName = document.createElement('td');
            const nameInput = document.createElement('input');
            nameInput.value = player.character.name || '';
            nameInput.style.width = '90%';
            tdName.appendChild(nameInput);
            tr.appendChild(tdName);

            // Classe
            const tdClass = document.createElement('td');
            const classSelect = document.createElement('select');
            ['Guerrier','Voleur','Mage','N√©cromancien','Archer'].forEach(c=>{
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                classSelect.appendChild(opt);
            });
            classSelect.value = player.character.classe || '';
            tdClass.appendChild(classSelect);
            tr.appendChild(tdClass);

            // √âquipe
            const tdTeam = document.createElement('td');
            const teamSelect = document.createElement('select');
            teamSelect.innerHTML = `
                <option value="Ordre du Dragon Pourpre ‚öîÔ∏è">Ordre du Dragon Pourpre ‚öîÔ∏è</option>
                <option value="Confr√©rie du Serpent Noir üêç">Confr√©rie du Serpent Noir üêç</option>
            `;
            teamSelect.value = player.character.team || "Ordre du Dragon Pourpre ‚öîÔ∏è";
            tdTeam.appendChild(teamSelect);
            tr.appendChild(tdTeam);

            // Niveau
            const tdLevel = document.createElement('td');
            tdLevel.textContent = player.level || 1;
            tr.appendChild(tdLevel);

            // XP
            const tdXP = document.createElement('td');
            tdXP.textContent = player.xp || 0;
            tr.appendChild(tdXP);

            // Actions
            const tdActions = document.createElement('td');

            // Enregistrer
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'üíæ';
            saveBtn.onclick = async () => {
                await db.collection('players').doc(uid).update({
                    "character.name": nameInput.value,
                    "character.classe": classSelect.value,
                    "character.team": teamSelect.value
                });
                if(currentUser === uid) showVillageForCurrentUser(teamSelect.value);
                adminHandler(); // refresh
                alert('Modifications enregistr√©es !');
            };
            tdActions.appendChild(saveBtn);

            // Supprimer
            const delBtn = document.createElement('button');
            delBtn.textContent = 'üóëÔ∏è';
            delBtn.onclick = async () => {
                if(confirm(`Supprimer ${player.character.name} ?`)){
                    await db.collection('players').doc(uid).update({ character: null });
                    adminHandler();
                    alert('Personnage supprim√©');
                }
            };
            tdActions.appendChild(delBtn);

            // Donner XP
            const xpBtn = document.createElement('button');
            xpBtn.textContent = '‚ú®';
            xpBtn.onclick = async () => {
                const amount = parseInt(prompt("Combien d'XP donner ?"));
                if(!amount || amount <= 0) return;
                await giveXpToPlayer(uid, player, amount);
                alert(`${amount} XP accord√©e`);
                adminHandler();
            };
            tdActions.appendChild(xpBtn);

            tr.appendChild(tdActions);

        } else {
            const td = document.createElement('td');
            td.colSpan = 6;
            td.textContent = 'Pas de personnage';
            td.style.textAlign = 'center';
            tr.appendChild(td);
        }

        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    adminPlayersList.appendChild(table);


    // ===== R√©parer le bouton fermer =====
    adminClose.onclick = () => {
        overlay.style.display = 'none';
        adminPopup.style.display = 'none';
    };
}




  // ========================
  // GIVE XP
  // ========================
  async function giveXpToPlayer(uid,player,xpGained){
      if(!player.character){ alert("Pas de personnage !"); return; }
      if(!player.character.stats) player.character.stats={attaque:0,defense:0,esquive:0,vie:0,pointsRestants:0};
      let xp=player.xp||0;
      let level=player.level||1;
      let stats=player.character.stats;
      xp+=xpGained;
      let leveledUp=false;
      let nextLevelXp=10*level;
      while(xp>=nextLevelXp){
          xp-=nextLevelXp;
          level++;
          stats.pointsRestants+=1;
          leveledUp=true;
          nextLevelXp=10*level;
      }
      await db.collection('players').doc(uid).update({xp:xp,level:level,"character.stats":stats});
      if(leveledUp) alert(`üéâ ${player.character.name} monte niveau ${level} ! (+1 PC)`);
  }

  // ========================
  // FICHE PERSONNAGE
  // ========================
  const statsElems = {
      attaque: sheetAttaque,
      defense: sheetDefense,
      esquive: sheetEsquive,
      vie: sheetVie
  };

  document.querySelectorAll('.stat-row .inc').forEach(btn=>{
      btn.onclick = () => {
          const stat = btn.dataset.stat;
          let val = parseInt(statsElems[stat].textContent);
          const totalPc = parseInt(pcText.dataset.totalPc);
          const used = Object.values(statsElems).reduce((acc,e)=>acc+parseInt(e.textContent),0);
          if(used < totalPc){
              statsElems[stat].textContent = val + 1;
              updateSheetPoints();
          }
      };
  });

  document.querySelectorAll('.stat-row .dec').forEach(btn=>{
      btn.onclick = () => {
          const stat = btn.dataset.stat;
          let val = parseInt(statsElems[stat].textContent);
          if(val > 0){
              statsElems[stat].textContent = val - 1;
              updateSheetPoints();
          }
      };
  });

  function openCharacterSheet(playerData){
      const stats = playerData.character.stats;
      const totalPc = (stats.attaque||0) + (stats.defense||0) + (stats.esquive||0) + (stats.vie||0) + (stats.pointsRestants||0);
      pcText.dataset.totalPc = totalPc;

      sheetAttaque.textContent = stats.attaque || 0;
      sheetDefense.textContent = stats.defense || 0;
      sheetEsquive.textContent = stats.esquive || 0;
      sheetVie.textContent = stats.vie || 0;

      document.getElementById('sheetClass').textContent = `Classe : ${playerData.character.classe}`;
      document.getElementById('sheetTeam').textContent = `√âquipe : ${playerData.character.team}`;
      document.getElementById('sheetLevel').textContent = `Niveau : ${playerData.level || 1}`;

      updateSheetPoints();
      overlay.style.display = 'block';
      characterSheetPopup.style.display = 'block';
  }

  function updateSheetPoints(){
      const used = parseInt(sheetAttaque.textContent) || 0
                 + parseInt(sheetDefense.textContent) || 0
                 + parseInt(sheetEsquive.textContent) || 0
                 + parseInt(sheetVie.textContent) || 0;
      const totalPc = parseInt(pcText.dataset.totalPc) || 0;
      const remaining = totalPc - used;
      pcText.textContent = `Points de Comp√©tence restants : ${remaining}`;
      pcText.style.color = remaining === 0 ? "red" : "#3b2f2f";
  }

  cancelStatsBtn.onclick = () => { overlay.style.display='none'; characterSheetPopup.style.display='none'; };
  saveStatsBtn.onclick = async () => {
      const attaque = parseInt(sheetAttaque.textContent) || 0;
      const defense = parseInt(sheetDefense.textContent) || 0;
      const esquive = parseInt(sheetEsquive.textContent) || 0;
      const vie = parseInt(sheetVie.textContent) || 0;

      const used = attaque + defense + esquive + vie;
      const totalPc = parseInt(pcText.dataset.totalPc) || 0;
      const remaining = totalPc - used;

      if(remaining < 0){ alert("Vous avez d√©pass√© vos points de comp√©tence !"); return; }

      await db.collection('players').doc(currentUser).update({
          "character.stats": {attaque, defense, esquive, vie, pointsRestants: remaining}
      });

      pcText.dataset.pc = remaining;
      pcText.textContent = `Points de Comp√©tence restants : ${remaining}`;
      pcText.style.color = remaining === 0 ? "red" : "#3b2f2f";

      overlay.style.display='none';
      characterSheetPopup.style.display='none';
      alert("Stats mises √† jour !");
  };

  // ========================
  // POPUPS
  // ========================
  function closeAllPopups(){
      overlay.style.display = 'none';
      createPopup.style.display = 'none';
      loginPopup.style.display = 'none';
      characterPopup.style.display = 'none';
      characterSheetPopup.style.display = 'none';
      adminPopup.style.display = 'none';
  }

  overlay.onclick = closeAllPopups;
  document.getElementById('createBtn').onclick = () => { overlay.style.display='block'; createPopup.style.display='block'; };
  document.getElementById('loginBtn').onclick = () => { overlay.style.display='block'; loginPopup.style.display='block'; };
  document.getElementById('createBack').onclick = closeAllPopups;
  document.getElementById('loginBack').onclick = closeAllPopups;

  // CREATION COMPTE
  document.getElementById('createSubmit').onclick = async () => {
      const email = document.getElementById('createEmail').value;
      const password = document.getElementById('createPassword').value;
      if(email && password){
          try {
              const userCredential = await auth.createUserWithEmailAndPassword(email,password);
              await db.collection('players').doc(userCredential.user.uid).set({character:null});
              alert("Compte cr√©√© !");
              closeAllPopups();
          } catch(e){ alert(e.message); }
      }
  };

  // CONNEXION
  document.getElementById('loginSubmit').onclick = async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      try{
          const userCredential = await auth.signInWithEmailAndPassword(email,password);
          currentUser = userCredential.user.uid;
          const doc = await db.collection('players').doc(currentUser).get();
          if(!doc.exists) await db.collection('players').doc(currentUser).set({character:null, level:1, xp:0});
          closeAllPopups();
      } catch(e){ alert("Erreur : " + e.message); }
  };

  // CREATION PERSONNAGE
  document.getElementById('characterSubmit').onclick = async () => {
      const name = document.getElementById('characterName').value;
      const classe = document.getElementById('characterClass').value;
      const attaque = parseInt(statAttaque.value)||0;
      const defense = parseInt(statDefense.value)||0;
      const esquive = parseInt(statEsquive.value)||0;
      const vie = parseInt(statVie.value)||0;
      const totalUsed = attaque+defense+esquive+vie;
      if(totalUsed > creationPointsRestants){ alert("Vous avez d√©pass√© vos 10 points !"); return; }
      const team = teamToggle===0?'Ordre du Dragon Pourpre ‚öîÔ∏è':'Confr√©rie du Serpent Noir üêç';
      teamToggle = teamToggle===0?1:0;
      await db.collection('players').doc(currentUser).set({
          character:{name,classe,team,stats:{attaque,defense,esquive,vie,pointsRestants:creationPointsRestants-totalUsed}},
          level:1,
          xp:0
      });
      closeAllPopups();
      showVillage({
          character:{name,classe,team,stats:{attaque,defense,esquive,vie,pointsRestants:creationPointsRestants-totalUsed}},
          level:1,
          xp:0
      });
  };

});
</script>


</body>
</html>
