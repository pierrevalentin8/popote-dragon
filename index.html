<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Popote & Dragon</title>
<style>
body {
  margin:0;
  font-family:'Courier New',monospace;
  background:#2b1b12;
  color:#f5deb3;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  padding:10px;
}
h1{text-align:center;font-size:24px;}
button{
  padding:5px 10px;
  margin:2px;
  font-family:'Courier New',monospace;
  font-size:14px;
  background:linear-gradient(#b57b3d,#7a4a2e);
  color:#fff2cc;
  border:3px solid #e0b97d;
  border-radius:4px;
  cursor:pointer;
}
button:hover{background:linear-gradient(#c88a45,#8a5535);}

/* Panels */
#creator,#charSheet,#adminPanel,#storyPanel,#arenaPanel{
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#3b2415;
  border:3px solid #c9a26b;
  padding:10px;
  border-radius:6px;
  box-shadow:0 0 10px rgba(0,0,0,0.7);
  max-width:90%;
  max-height:90vh;
  overflow:auto;
}

/* Barre XP */
.xp-bar-container {
  width: 100%;
  height: 15px;
  background: #555;
  border: 1px solid #c9a26b;
  border-radius: 8px;
  margin: 5px 0 10px 0;
  overflow: hidden;
}
.xp-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(to right, #00f, #00aaff);
  transition: width 0.5s ease;
}

/* Fiche joueur */
.char-card {
  background:#3b2415;
  border:3px solid #c9a26b;
  border-radius:10px;
  padding:20px;
  max-width:400px;
  width:90%;
  color:#fff2cc;
  box-shadow:0 4px 15px rgba(0,0,0,0.7);
}
.char-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}
.char-header h2 {margin:0;font-size:22px;color:#ffd700;}
.char-class {font-size:16px;font-style:italic;background:#7a4a2e;padding:3px 8px;border-radius:6px;}
.char-info p {margin:5px 0;line-height:1.3;}
.stats-container {display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.stat-line {display:flex;align-items:center;gap:10px;}
.stat-btn {font-size:14px;padding:3px 8px;background:linear-gradient(#b57b3d,#7a4a2e);color:#fff2cc;border:2px solid #e0b97d;border-radius:5px;cursor:pointer;}
.stat-btn:hover {background:linear-gradient(#c88a45,#8a5535);}
.close-btn {margin-top:15px;padding:8px 15px;background:#b57b3d;color:#fff2cc;border:none;border-radius:6px;cursor:pointer;}
.close-btn:hover {background:#c88a45;}

/* Admin */
.admin-char-line{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:4px 6px;
  margin-bottom:4px;
  background:#4a2d1a;
  border-radius:4px;
}
.admin-char-info{font-size:14px;flex:1;}
.admin-char-actions{display:flex;gap:4px;align-items:center;}
input[type="number"]{width:60px;padding:2px 4px;border-radius:3px;border:1px solid #c9a26b;background:#2b1b12;color:#f5deb3;}
textarea{width:95%;height:50px;background:#2b1b12;color:#f5deb3;border:1px solid #c9a26b;border-radius:4px;}

/* Boss */
.boss-container{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#4a2d1a;
  padding:4px 6px;
  border-radius:4px;
  margin:4px 0;
}
.boss-info{flex:1;display:flex;align-items:center;gap:10px;}
.boss-hp-bar{width:100px;height:12px;background:#555;border:1px solid #c9a26b;border-radius:3px;}
.boss-hp-fill{height:100%;background:#0f0;border-radius:2px;width:100%;}
#bossProgress{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;}
.bossProgressItem{width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:#000;font-size:12px;font-weight:bold;}
.bossVaincu{background:#0f0;}
.bossDisponible{background:#ff0;}
.bossBloque{background:#888;}

/* Ar√®ne */
#arenaLog{
  background:#2b1b12;
  border:1px solid #c9a26b;
  border-radius:4px;
  padding:10px;
  max-height:200px;
  overflow-y:auto;
  margin:10px 0;
  color:#fff2cc;
  font-family:'Courier New',monospace;
  font-size:14px;
}
#fightBtn{
  padding:6px 12px;
  margin:5px 0;
  font-family:'Courier New',monospace;
  font-size:14px;
  background:linear-gradient(#b57b3d,#7a4a2e);
  color:#fff2cc;
  border:3px solid #e0b97d;
  border-radius:4px;
  cursor:pointer;
}
#fightBtn:hover{background:linear-gradient(#c88a45,#8a5535);}

/* Responsive mobile */
@media (max-width:600px){
  body{padding:5px;font-size:14px;}
  h1{font-size:20px;}
  button{font-size:12px;padding:6px 8px;}
  #creator,#charSheet,#adminPanel,#storyPanel,#arenaPanel{width:95%;max-height:90vh;padding:10px;}
  .char-card{padding:15px;width:100%;}
  .char-header{flex-direction:column;align-items:flex-start;gap:5px;}
  .stats-container .stat-line{flex-direction:row;align-items:center;gap:5px;}
  .boss-container{flex-direction:column;align-items:flex-start;gap:5px;}
  .boss-info{flex-direction:column;align-items:flex-start;}
  #bossProgress{gap:2px;flex-wrap:wrap;}
  #bossProgress .bossProgressItem{width:25px;height:25px;font-size:10px;}
  textarea{width:100%;height:40px;}
  input[type="text"], select, input[type="number"]{width:100%;box-sizing:border-box;}
}
</style>
</head>
<body>

<h1>üçó Popote & Dragon üêâ</h1>
<button id="createBtn">Cr√©er son personnage</button>
<button id="playerBtn" style="display:none;"></button>
<button id="adminBtn">Ma√Ætre du Jeu</button>
<button id="storyBtn">Histoire</button>
<button id="arenaBtn">Ar√®ne</button>

<!-- CREATION -->
<div id="creator">
<h2>Cr√©er ton personnage</h2>
<input type="text" id="name" placeholder="Nom"><br><br>
<select id="class">
<option>Guerrier</option>
<option>Mage</option>
<option>Voleur</option>
<option>Popotier</option>
</select><br><br>
<textarea id="desc" placeholder="Description"></textarea>
<h3>Points initiaux (10)</h3>
<p>Points restants : <span id="pointsLeft">10</span></p>
<div class="stat-line">Force : <button onclick="changeStat('force',-1)">-</button> <span id="force">0</span> <button onclick="changeStat('force',1)">+</button></div>
<div class="stat-line">PV : <button onclick="changeStat('pv',-1)">-</button> <span id="pv">0</span> <button onclick="changeStat('pv',1)">+</button></div>
<div class="stat-line">D√©fense : <button onclick="changeStat('defense',-1)">-</button> <span id="defense">0</span> <button onclick="changeStat('defense',1)">+</button></div>
<div class="stat-line">Agilit√© : <button onclick="changeStat('agilite',-1)">-</button> <span id="agilite">0</span> <button onclick="changeStat('agilite',1)">+</button></div>
<button onclick="validateCharacter()">Valider</button>
</div>

<!-- FICHE JOUEUR -->
<div id="charSheet">
  <div class="char-card">
    <div class="char-header">
      <h2 id="sheetName"></h2>
      <span class="char-class" id="sheetClass"></span>
    </div>
    <div class="char-info">
      <p><strong>Niveau :</strong> <span id="sheetLevel"></span></p>
      <p><strong>XP :</strong> <span id="sheetXP"></span></p>
      <div class="xp-bar-container">
        <div class="xp-bar" id="sheetXPBar"></div>
      </div>
      <p><strong>Description :</strong></p>
      <p id="sheetDesc"></p>
    </div>
    <h3>Stats</h3>
    <div class="stats-container">
      <div class="stat-line">Force : <span id="sheetForce"></span>
        <button class="stat-btn" onclick="changeSheetStat('force',1)">+</button>
        <button class="stat-btn" onclick="changeSheetStat('force',-1)">-</button>
      </div>
      <div class="stat-line">PV : <span id="sheetPV"></span>
        <button class="stat-btn" onclick="changeSheetStat('pv',1)">+</button>
        <button class="stat-btn" onclick="changeSheetStat('pv',-1)">-</button>
      </div>
      <div class="stat-line">D√©fense : <span id="sheetDefense"></span>
        <button class="stat-btn" onclick="changeSheetStat('defense',1)">+</button>
        <button class="stat-btn" onclick="changeSheetStat('defense',-1)">-</button>
      </div>
      <div class="stat-line">Agilit√© : <span id="sheetAgilite"></span>
        <button class="stat-btn" onclick="changeSheetStat('agilite',1)">+</button>
        <button class="stat-btn" onclick="changeSheetStat('agilite',-1)">-</button>
      </div>
    </div>
    <p>Points disponibles : <span id="freePoints"></span></p>
    <button onclick="closeSheet()" class="close-btn">Fermer</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPanel">
<h3>Ma√Ætre du Jeu</h3>
<div id="adminCharList"></div>
<button onclick="closeAdmin()">Fermer</button>
</div>

<!-- STORY / BOSS -->
<div id="storyPanel">
<h3>Progression Histoire</h3>
<div id="bossProgress"></div>
<div id="bossList"></div>
<button onclick="closeStory()">Fermer</button>
</div>

<!-- ARENE -->
<div id="arenaPanel">
  <h3>Ar√®ne</h3>
  <p id="arenaStatus">Choisis ton adversaire et combat !</p>

  <div style="display:flex;justify-content:space-between;margin:10px 0;">
    <div>
      <strong id="arenaPlayerName"></strong>
      <div class="boss-hp-bar" style="width:120px;">
        <div id="arenaPlayerHP" class="boss-hp-fill" style="width:100%;"></div>
      </div>
    </div>
    <div>
      <strong id="arenaOpponentName"></strong>
      <div class="boss-hp-bar" style="width:120px;">
        <div id="arenaOpponentHP" class="boss-hp-fill" style="width:100%;"></div>
      </div>
    </div>
  </div>

  <button id="fightBtn">Combattre</button>
  <pre id="arenaLog"></pre>
  <button onclick="closeArena()" class="close-btn">Fermer</button>
</div>

<script>
// --- Variables --- 
let stats={force:0,pv:0,defense:0,agilite:0};
let totalPoints=10;

// --- Cr√©ation personnage ---
document.getElementById("createBtn").onclick = () => { document.getElementById("creator").style.display = "block"; };
function changeStat(stat,val){
  if(val===1 && totalPoints<=0) return;
  if(val===-1 && stats[stat]<=0) return;
  stats[stat]+=val;
  totalPoints-=val;
  document.getElementById(stat).textContent=stats[stat];
  document.getElementById("pointsLeft").textContent=totalPoints;
}
function validateCharacter(){
  if(totalPoints!==0){alert("Utilise tous les points !");return;}
  const newChar={name:document.getElementById("name").value||"H√©ros",cls:document.getElementById("class").value,desc:document.getElementById("desc").value||"",stats:{...stats},level:1,xp:0,freePoints:0,lastAttack:{}};
  let characters=JSON.parse(localStorage.getItem("characters")||"[]");
  characters.push(newChar);
  localStorage.setItem("characters",JSON.stringify(characters));
  document.getElementById("createBtn").style.display="none";
  document.getElementById("playerBtn").textContent=newChar.name;
  document.getElementById("playerBtn").style.display="inline-block";
  document.getElementById("creator").style.display="none";
}

// --- XP & Niveau ---
function xpForNextLevel(level){ return level*10; }
function checkLevelUp(character){
  while(character.xp >= xpForNextLevel(character.level)){
    character.xp -= xpForNextLevel(character.level);
    character.level++;
    character.freePoints+=2;
  }
}
function getTotalXP(character){
  let total = character.xp;
  for(let lvl=1;lvl<character.level;lvl++){total+=xpForNextLevel(lvl);}
  return total;
}

// --- Fiche joueur ---
document.getElementById("playerBtn").onclick=()=>{ const characters=JSON.parse(localStorage.getItem("characters")||"[]"); if(!characters.length) return; const c=characters[0]; refreshSheet(c); document.getElementById("charSheet").style.display="block"; }
function refreshSheet(c){
  document.getElementById("sheetName").textContent=c.name;
  document.getElementById("sheetClass").textContent=c.cls;
  document.getElementById("sheetLevel").textContent=c.level;
  document.getElementById("sheetXP").textContent=c.xp+" XP";
  document.getElementById("sheetDesc").textContent=c.desc;
  document.getElementById("sheetForce").textContent=c.stats.force;
  document.getElementById("sheetPV").textContent=c.stats.pv;
  document.getElementById("sheetDefense").textContent=c.stats.defense;
  document.getElementById("sheetAgilite").textContent=c.stats.agilite;
  document.getElementById("freePoints").textContent=c.freePoints;
  let xpForNext=xpForNextLevel(c.level);
  document.getElementById("sheetXPBar").style.width=Math.min(100,(c.xp/xpForNext)*100)+"%";
}
function changeSheetStat(stat,val){
  let characters=JSON.parse(localStorage.getItem("characters")||"[]");
  const c=characters[0];
  if(val===1 && c.freePoints<=0) return;
  if(val===-1 && c.stats[stat]<=0) return;
  c.stats[stat]+=val;
  c.freePoints-=val;
  characters[0]=c;
  localStorage.setItem("characters",JSON.stringify(characters));
  refreshSheet(c);
}
function closeSheet(){document.getElementById("charSheet").style.display="none";}

// --- Admin ---
document.getElementById("adminBtn").onclick=()=>{
  const pwd=prompt("Mot de passe MJ :");
  if(pwd!=="master123"){alert("Acc√®s refus√©");return;}
  renderAdminList();
  document.getElementById("adminPanel").style.display="block";
}
function renderAdminList(){
  const container=document.getElementById("adminCharList");
  container.innerHTML="";
  const characters=JSON.parse(localStorage.getItem("characters")||"[]");
  characters.forEach((c,index)=>{
    const line=document.createElement("div");
    line.className="admin-char-line";
    const info=document.createElement("div");
    info.className="admin-char-info";
    info.textContent=`${c.name} - Niveau: ${c.level} - XP totale: ${getTotalXP(c)}`;
    const actions=document.createElement("div");
    actions.className="admin-char-actions";
    const input=document.createElement("input"); input.type="number"; input.placeholder="XP"; input.min=0;
    const btn=document.createElement("button"); btn.textContent="Ajouter XP";
    btn.onclick=()=>{
      let val=parseInt(input.value);
      if(isNaN(val)||val<=0) return;
      c.xp+=val;
      checkLevelUp(c);
      characters[index]=c;
      localStorage.setItem("characters",JSON.stringify(characters));
      renderAdminList();
      alert("XP ajout√©e !");
    };
    actions.appendChild(input); actions.appendChild(btn);
    line.appendChild(info); line.appendChild(actions);
    container.appendChild(line);
  });
}
function closeAdmin(){document.getElementById("adminPanel").style.display="none";}

// --- Boss / Histoire ---
let bosses=[{name:"Graduku", hpMax:100, hp:100, defeated:false, xpReward:20},{name:"Drakzor", hpMax:150, hp:150, defeated:false, xpReward:30},{name:"Tornak", hpMax:200, hp:200, defeated:false, xpReward:40},{name:"Morgath", hpMax:250, hp:250, defeated:false, xpReward:50},{name:"Zeroth", hpMax:300, hp:300, defeated:false, xpReward:60},{name:"Vulgrim", hpMax:350, hp:350, defeated:false, xpReward:70},{name:"Fangor", hpMax:400, hp:400, defeated:false, xpReward:80},{name:"Cindral", hpMax:450, hp:450, defeated:false, xpReward:90},{name:"Oryn", hpMax:500, hp:500, defeated:false, xpReward:100},{name:"Eldrax", hpMax:600, hp:600, defeated:false, xpReward:120}];

function saveBosses(){ localStorage.setItem("bosses",JSON.stringify(bosses)); }
function loadBosses(){ let saved=JSON.parse(localStorage.getItem("bosses")||"null"); if(saved) bosses=saved; }

document.getElementById("storyBtn").onclick=()=>{
  loadBosses();
  renderBossProgress();
  renderBossList();
  document.getElementById("storyPanel").style.display="block";
};
function closeStory(){ document.getElementById("storyPanel").style.display="none"; }

function renderBossProgress(){
  const container=document.getElementById("bossProgress");
  container.innerHTML="";
  bosses.forEach((boss,index)=>{
    const div=document.createElement("div");
    div.className="bossProgressItem";
    if(boss.defeated) div.classList.add("bossVaincu");
    else if(index===0 || bosses[index-1].defeated) div.classList.add("bossDisponible");
    else div.classList.add("bossBloque");
    div.textContent=boss.name.charAt(0);
    container.appendChild(div);
  });
}

function renderBossList(){
  const container=document.getElementById("bossList");
  container.innerHTML="";
  const characters=JSON.parse(localStorage.getItem("characters")||"[]");
  if(!characters.length) return;
  const player=characters[0];
  bosses.forEach((boss,index)=>{
    const div=document.createElement("div");
    div.className="boss-container";
    const infoDiv=document.createElement("div");
    infoDiv.className="boss-info";
    let status="";
    if(index>0 && !bosses[index-1].defeated){ status=" (Bloqu√©)"; div.style.opacity="0.5"; }
    else if(boss.defeated){ status=" (Vaincu)"; }
    infoDiv.textContent=`${boss.name} - PV: ${boss.hp}/${boss.hpMax}${status}`;
    const hpBar=document.createElement("div"); hpBar.className="boss-hp-bar";
    const hpFill=document.createElement("div"); hpFill.className="boss-hp-fill";
    hpFill.style.width=(boss.hp/boss.hpMax*100)+"%";
    hpFill.style.background=boss.hp/boss.hpMax<0.3?"#f00":"#0f0";
    hpBar.appendChild(hpFill); infoDiv.appendChild(hpBar);
    div.appendChild(infoDiv);
    if(!boss.defeated && (index===0 || bosses[index-1].defeated)){
      const attackBtn=document.createElement("button"); attackBtn.textContent="Attaquer";
      attackBtn.onclick=()=>{ attackBoss(index,player); };
      div.appendChild(attackBtn);
    }
    container.appendChild(div);
  });
}

function attackBoss(index,player){
  const boss=bosses[index]; const today=new Date().toDateString();
  if(!player.lastAttack) player.lastAttack={};
  if(player.lastAttack[boss.name]===today){ alert("Vous ne pouvez attaquer ce boss qu'une fois par jour !"); return; }
  const dmg=Math.floor(player.stats.force + player.stats.agilite/2);
  boss.hp=Math.max(0,boss.hp - dmg);
  let xpGained=0;
  if(boss.hp===0){ boss.defeated=true; xpGained=boss.xpReward; alert(`Boss ${boss.name} vaincu !`); }
  player.lastAttack[boss.name]=today;
  player.xp+=xpGained;
  checkLevelUp(player);
  const characters=JSON.parse(localStorage.getItem("characters")||"[]");
  characters[0]=player; localStorage.setItem("characters",JSON.stringify(characters));
  saveBosses(); renderBossProgress(); renderBossList();
}

// --- Ar√®ne ---
document.getElementById("arenaBtn").onclick = () => {
  const characters = JSON.parse(localStorage.getItem("characters")||"[]");
  if(!characters.length) { alert("Cr√©e un personnage d'abord !"); return; }
  if(characters.length < 2) { alert("Il faut au moins deux personnages pour un duel !"); return; }
  document.getElementById("arenaPanel").style.display = "block";
  document.getElementById("arenaLog").textContent = "";
  document.getElementById("arenaStatus").textContent = "Pr√™t pour le combat ?";
};

function closeArena(){ document.getElementById("arenaPanel").style.display="none"; }

document.getElementById("fightBtn").onclick = async () => {
  const characters = JSON.parse(localStorage.getItem("characters")||"[]");
  if(characters.length < 2) { alert("Pas assez de personnages pour un duel."); return; }

  const player = characters[0];
  const today = new Date().toDateString();
  if(!player.arena) player.arena = {date:today,count:0};
  if(player.arena.date !== today) player.arena = {date:today,count:0};
  if(player.arena.count >= 3) { alert("Tu as d√©j√† fait 3 combats aujourd'hui !"); return; }

  const others = characters.slice(1);
  const opponent = others[Math.floor(Math.random()*others.length)];

  document.getElementById("arenaPlayerName").textContent = player.name;
  document.getElementById("arenaOpponentName").textContent = opponent.name;
  document.getElementById("arenaPlayerHP").style.width = player.stats.pv + "%";
  document.getElementById("arenaOpponentHP").style.width = opponent.stats.pv + "%";

  const log = await duelAnimated(player, opponent);

  player.arena.count += 1;
  characters[0] = player;
  localStorage.setItem("characters", JSON.stringify(characters));

  document.getElementById("arenaLog").textContent = log;
};

async function duelAnimated(p1, p2){
  let hp1 = p1.stats.pv, hp2 = p2.stats.pv;
  let maxHP1 = hp1, maxHP2 = hp2;
  let log = `Combat ${p1.name} vs ${p2.name}\n\n`;

  const playerHPBar = document.getElementById("arenaPlayerHP");
  const opponentHPBar = document.getElementById("arenaOpponentHP");

  function updateHP(bar, hp, maxHp){
    bar.style.width = Math.max(0,(hp/maxHp)*100) + "%";
  }

  while(hp1>0 && hp2>0){
    await new Promise(r=>setTimeout(r,500));
    let dmg1 = Math.max(0, p1.stats.force - p2.stats.defense);
    if(Math.random()*100 < p2.stats.agilite*5) dmg1=0;
    hp2 -= dmg1;
    log += `${p1.name} inflige ${dmg1} √† ${p2.name} (${hp2>0?hp2:0} PV restant)\n`;
    updateHP(opponentHPBar,hp2,maxHP2);
    await new Promise(r=>setTimeout(r,500));
    if(hp2<=0) break;

    let dmg2 = Math.max(0, p2.stats.force - p1.stats.defense);
    if(Math.random()*100 < p1.stats.agilite*5) dmg2=0;
    hp1 -= dmg2;
    log += `${p2.name} inflige ${dmg2} √† ${p1.name} (${hp1>0?hp1:0} PV restant)\n`;
    updateHP(playerHPBar,hp1,maxHP1);
    await new Promise(r=>setTimeout(r,500));
  }

  if(hp1>0) log += `\n${p1.name} gagne le duel !`;
  else log += `\n${p2.name} gagne le duel !`;

  return log;
}

// --- Initialisation page ---
window.onload=()=>{
  const characters=JSON.parse(localStorage.getItem("characters")||"[]");
  if(characters.length){
    document.getElementById("createBtn").style.display="none";
    document.getElementById("playerBtn").textContent=characters[0].name;
    document.getElementById("playerBtn").style.display="inline-block";
  }
  loadBosses();
};
</script>
</body>
</html>
